<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">src/lib/rle.js | icon-gen</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  <script src="script/manual.js"></script>
<meta name="description" content="Generate an icon files from the SVG or PNG files"><meta property="twitter:card" content="summary"><meta property="twitter:title" content="icon-gen"><meta property="twitter:description" content="Generate an icon files from the SVG or PNG files"></head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  <a href="test.html" data-ice="testLink">Test</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
<a style="position:relative; top:3px;" href="https://github.com/akabekobeko/npm-icon-gen"><img width="20px" src="./image/github.png"></a></header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ICNSIconInfo">ICNSIconInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ICODirectory">ICODirectory</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ICOHeader">ICOHeader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-typedef">T</span><span data-ice="name"><span><a href="typedef/index.html#static-typedef-ImageInfo">ImageInfo</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/buffer.html">Buffer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-external">E</span><span data-ice="name"><span><a href="https://nodejs.org/api/stream.html">WritableStream</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#bin">bin</a><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-CLI">CLI</a></span></span></li>
<li data-ice="doc"><a data-ice="dirPath" class="nav-dir-path" href="identifiers.html#lib">lib</a><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/logger.js~Logger.html">Logger</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/src/lib/util.js~Util.html">Util</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GenerateFavicon">GenerateFavicon</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GetRequiredFavoriteImageSizes">GetRequiredFavoriteImageSizes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-DebugUnpackIconBlocks">DebugUnpackIconBlocks</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GenerateICNS">GenerateICNS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GetRequiredICNSImageSizes">GetRequiredICNSImageSizes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GenerateICO">GenerateICO</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GetRequiredICOImageSizes">GetRequiredICOImageSizes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GenerateIcon">GenerateIcon</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GeneratePNG">GeneratePNG</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GetRequiredPNGImageSizes">GetRequiredPNGImageSizes</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PackBits">PackBits</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-PackICNS">PackICNS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UnpackBits">UnpackBits</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">src/lib/rle.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">/**
 * Max length of PackBits literal.
 * @type {Number}
 */
const MAX_LITERAL_LENGTH = 127

/**
 * Copies the array to the target array at the specified position and size.
 * @param {Number[]} src Byte array of copy source.
 * @param {Number} srcBegin  Copying start position of source.
 * @param {Number[]} dest Bayte array of copy destination.
 * @param {Number} destBegin Writing start position of destinnation.
 * @param {Number} size Size of copy bytes.
 */
const arrayCopy = (src, srcBegin, dest, destBegin, size) =&gt; {
  if (src.length &lt;= srcBegin || src.length &lt; size || dest.length &lt;= destBegin || dest.length &lt; size) {
    return
  }

  for (let i = srcBegin, j = destBegin, k = 0; k &lt; size; ++i, ++j, ++k) {
    dest[j] = src[i]
  }
}

/**
 * Convert a 8bit signed value to unsigned value.
 * @param {Number} value 8bit signed value (-127 to 127)
 * @return {Number} Unsigned value (0 to 255).
 */
const toUInt8 = (value) =&gt; {
  return value &amp; 0xff
}

/**
 * Convert a 8bit unsigned value to signed value.
 * @param {Number} value 8bit unsigned value (0 to 255).
 * @return {Number} Signed value (-127 to 127).
 * @see https://github.com/inexorabletash/polyfill/blob/master/typedarray.js
 */
const toInt8 = (value) =&gt; {
  return (value &lt;&lt; 24) &gt;&gt; 24
}

/**
 * Convert PackBits literals to resuls.
 *
 * @param {Array.&lt;Number&gt;} literals PackBits literals.
 *
 * @return {Array.&lt;Number&gt;} Converted literals.
 */
const packBitsLiteralToResult = (literals) =&gt; {
  return literals.length === 0 ? [] : [toUInt8(literals.length - 1)].concat(literals)
}

/**
 * Decompress PackBits compressed binary.
 * This method port Geeks with Blogs&apos;s code (Apache License v2.0) to Node.
 * @param {Number[]} src Source binary.
 * @return {Number[]} Decompressed binary.
 * @see https://en.wikipedia.org/wiki/PackBits
 * @see http://geekswithblogs.net/rakker/archive/2015/12/14/packbits-in-c.aspx
 */
export const UnpackBits = (src) =&gt; {
  const dest = []
  for (let i = 0, max = src.length; i &lt; max; ++i) {
    const count = toInt8(toUInt8(src[i]))
    if (count === -128) {
      // Do nothing, skip it
    } else if (0 &lt;= count) {
      const total = count + 1
      for (let j = 0; j &lt; total; ++j) {
        dest.push(toUInt8(src[i + j + 1]))
      }

      i += total
    } else {
      const total = Math.abs(count) + 1
      for (let j = 0; j &lt; total; ++j) {
        dest.push(toUInt8(src[i + 1]))
      }

      ++i
    }
  }

  return dest
}

/**
 * Compress binary with ICNS RLE.
 * @param {Number[]} src Source binary.
 * @return {Number[]} Compressed binary.
 * @see https://github.com/fiji/IO/blob/master/src/main/java/sc/fiji/io/icns/RunLengthEncoding.java
 */
export const PackICNS = (src) =&gt; {
  // If it is not redundant, keep the size large enough to increase the size
  const packedData = new Array(src.length * 2).fill(0)

  let output = 0
  for (let input = 0; input &lt; src.length; ) {
    let literalStart = input
    let currentData = src[input++]

    // Read up to 128 literal bytes
    // Stop if 3 or more consecutive bytes are equal or EOF is reached
    let readBytes = 1
    let repeatedBytes = 0
    while (input &lt; src.length &amp;&amp; readBytes &lt; 128 &amp;&amp; repeatedBytes &lt; 3) {
      const nextData = src[input++]
      if (nextData === currentData) {
        if (repeatedBytes === 0) {
          repeatedBytes = 2
        } else {
          repeatedBytes++
        }
      } else {
        repeatedBytes = 0
      }

      readBytes++
      currentData = nextData
    }

    let literalBytes = 0
    if (repeatedBytes &lt; 3) {
      literalBytes = readBytes
      repeatedBytes = 0
    } else {
      literalBytes = readBytes - repeatedBytes
    }

    // Write the literal bytes that were read
    if (0 &lt; literalBytes) {
      packedData[output++] = toUInt8(literalBytes - 1)
      arrayCopy(src, literalStart, packedData, output, literalBytes)
      output += literalBytes
    }

    // Read up to 130 consecutive bytes that are equal
    while (input &lt; src.length &amp;&amp; src[input] === currentData &amp;&amp; repeatedBytes &lt; 130) {
      repeatedBytes++
      input++
    }

    if (3 &lt;= repeatedBytes) {
      // Write the repeated bytes if there are 3 or more
      packedData[output++] = toUInt8(repeatedBytes + 125)
      packedData[output++] = currentData
    } else {
      // Else move back the in pointer to ensure the repeated bytes are included in the next literal string
      input -= repeatedBytes
    }
  }

  // Trim to the actual size
  const dest = new Array(output).fill(0)
  arrayCopy(packedData, 0, dest, 0, output)

  return dest
}

/**
 * Compress binary with PackBits.
 * This method port Geeks with Blogs&apos;s code (Apache License v2.0) to Node.
 * @param {Number[]} src Source binary.
 * @return {Number[]} Compressed binary.
 * @see https://en.wikipedia.org/wiki/PackBits
 * @see http://geekswithblogs.net/rakker/archive/2015/12/14/packbits-in-c.aspx
 */
export const PackBits = (src) =&gt; {
  if (!(src &amp;&amp; src.length &amp;&amp; 0 &lt; src.length)) {
    return []
  }

  let dest = []
  let literals = []

  for (let i = 0, max = src.length; i &lt; max; ++i) {
    const current = toUInt8(src[i])
    if (i + 1 &lt; max) {
      const next = toUInt8(src[i + 1])
      if (current === next) {
        dest = dest.concat(packBitsLiteralToResult(literals))
        literals = []

        const maxJ = max &lt;= i + MAX_LITERAL_LENGTH ? max - i - 1 : MAX_LITERAL_LENGTH
        let hitMax = true
        let runLength = 1

        for (let j = 2; j &lt;= maxJ; ++j) {
          const run = src[i + j]
          if (current !== run) {
            hitMax = false
            const count = toUInt8(0 - runLength)
            i += j - 1
            dest.push(count)
            dest.push(current)
            break
          }

          ++runLength
        }

        if (hitMax) {
          dest.push(toUInt8(0 - maxJ))
          dest.push(current)
          i += maxJ
        }
      } else {
        literals.push(current)
        if (literals.length === MAX_LITERAL_LENGTH) {
          dest = dest.concat(packBitsLiteralToResult(literals))
          literals = []
        }
      }
    } else {
      literals.push(current)
      dest = dest.concat(packBitsLiteralToResult(literals))
      literals = []
    }
  }

  return dest
}
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(1.1.0)</span><img src="./image/esdoc-logo-mini-black.png"></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
